import{r as l,u as S,j as e,a as u}from"./index-DQupXFMp.js";function M({mode:d,user:n,onClose:p,onSuccess:b}){const r=d==="edit",[c,h]=l.useState({firstName:"",lastName:"",nationalCode:"",mobile:"",email:"",centerCode:"",username:"",isActive:!0}),[x,j]=l.useState(null),{centers:N}=S();l.useEffect(()=>{r&&n&&h({firstName:n.firstName||"",lastName:n.lastName||"",nationalCode:n.nationalCode||"",mobile:n.mobile||"",email:n.email||"",centerCode:n.centerCode||"",username:n.username||"",isActive:n.isActive??!0})},[r,n]);function i(o){const{name:t,value:a,type:m,checked:v}=o.target;h(y=>({...y,[t]:m==="checkbox"?v:a}))}async function f(o){o.preventDefault();const t={...c,password:c.nationalCode||"Spnu123"};try{r?(await u.put(`/api/users/${n.id}`,t),j("ویرایش با موفقیت انجام شد")):(await u.post("/api/users",t),j("کاربر جدید افزوده شد")),b?.(),p()}catch(a){j(a.message||"خطا در ذخیره اطلاعات")}}return e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{background:"#00000066"},children:e.jsx("div",{className:"modal-dialog modal-lg modal-dialog-centered",children:e.jsxs("div",{className:"modal-content text-end",style:{direction:"rtl"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:r?"ویرایش کاربر":"افزودن کاربر جدید"}),e.jsx("button",{type:"button",className:"btn-close",onClick:p})]}),e.jsxs("div",{className:"modal-body",children:[x&&e.jsx("div",{className:"alert alert-info",children:x}),e.jsxs("form",{onSubmit:f,className:"row g-3 align-item-center",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"نام"}),e.jsx("input",{type:"text",name:"firstName",className:"form-control",value:c.firstName,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"نام خانوادگی"}),e.jsx("input",{type:"text",name:"lastName",className:"form-control",value:c.lastName,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"کد ملی"}),e.jsx("input",{type:"text",name:"nationalCode",className:"form-control",value:c.nationalCode,onChange:i})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"موبایل"}),e.jsx("input",{type:"text",name:"mobile",className:"form-control",value:c.mobile,onChange:i})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"ایمیل"}),e.jsx("input",{type:"email",name:"email",className:"form-control",value:c.email,onChange:i})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"مرکز"}),e.jsxs("select",{name:"centerCode",className:"form-select",value:c.centerCode,onChange:i,children:[e.jsx("option",{value:"",children:"انتخاب مرکز"}),N.map(o=>e.jsx("option",{value:o.centerCode,children:o.title},o.centerCode))]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label",children:"نام کاربری"}),e.jsx("input",{type:"text",name:"username",className:"form-control",value:c.username,onChange:i,required:!0})]}),e.jsxs("div",{className:"col-md-6 d-flex align-items-center",children:[e.jsx("input",{type:"checkbox",name:"isActive",className:"form-check-input ms-2",checked:c.isActive,onChange:i}),e.jsx("label",{className:"form-check-label",children:"فعال باشد"})]}),e.jsxs("div",{className:"col-12 d-flex justify-content-between",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",children:"ذخیره"}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:p,children:"انصراف"})]})]})]})]})})})}function R({user:d,onClose:n,onSuccess:p}){const[b,r]=l.useState([]),[c,h]=l.useState([]),[x,j]=l.useState(!0),[N,i]=l.useState(null);l.useEffect(()=>{async function t(){j(!0);try{const a=await u.get("/api/roles"),m=await u.get(`/api/users/${d.id}/roles`);r(a),h(m.map(v=>v.roleId))}catch{i("خطا در دریافت نقش‌ها")}finally{j(!1)}}t()},[d.id]);async function f(t){try{await u.post(`/api/users/${d.id}/roles/${t}`),h(a=>[...a,t])}catch{i("خطا در تخصیص نقش")}}async function o(t){try{await u.delete(`/api/users/${d.id}/roles/${t}`),h(a=>a.filter(m=>m!==t))}catch{i("خطا در حذف نقش")}}return e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{background:"#00000066"},children:e.jsx("div",{className:"modal-dialog modal-lg modal-dialog-centered",children:e.jsxs("div",{className:"modal-content text-end",style:{direction:"rtl"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:["نقش‌های کاربر: ",d.firstName," ",d.lastName]}),e.jsx("button",{type:"button",className:"btn-close",onClick:n})]}),e.jsxs("div",{className:"modal-body",children:[N&&e.jsx("div",{className:"alert alert-info",children:N}),x?e.jsx("div",{children:"در حال بارگذاری نقش‌ها..."}):e.jsxs("table",{className:"table table-bordered table-sm text-center",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"عنوان نقش"}),e.jsx("th",{children:"عملیات"})]})}),e.jsxs("tbody",{children:[b.map((t,a)=>{const m=c.includes(t.id);return e.jsxs("tr",{children:[e.jsx("td",{children:a+1}),e.jsx("td",{children:t.description}),e.jsx("td",{children:m?e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>o(t.id),children:"عدم تخصیص نقش"}):e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>f(t.id),children:"تخصیص نقش"})})]},t.id)}),b.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"3",children:"هیچ نقشی یافت نشد."})})]})]})]})]})})})}function A(){const[d,n]=l.useState([]),[p,b]=l.useState(!0),[r,c]=l.useState(null),[h,x]=l.useState(!1),[j,N]=l.useState("add"),[i,f]=l.useState(null),[o,t]=l.useState(!1),{centers:a}=S();function m(){N("add"),f(null),x(!0)}function v(s){N("edit"),f(s),x(!0)}function y(s){f(s),t(!0)}l.useEffect(()=>{window.history.pushState({section:"users"},"","#users");const s=g=>{g.state?.section!=="users"&&(window.location.href="/dashboard")};return window.addEventListener("popstate",s),C(),()=>{window.removeEventListener("popstate",s)}},[]);async function C(){b(!0);try{const s=await u.get("/api/users");n(s)}catch{c("خطا در دریافت کاربران")}finally{b(!1)}}async function k(s){try{await u.post(`/api/users/${s}/reset-password`)}catch{c("خطا در ریست کردن رمز کاربر")}}return e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-right mb-3 gap-4",children:[e.jsx("h6",{className:"mb-0",children:"لیست کاربران"}),e.jsx("button",{className:"btn btn-success btn-sm ms-auto",onClick:m,children:"افزودن کاربر جدید"})]}),r&&e.jsx("div",{className:"alert alert-info",children:r}),p?e.jsx("div",{children:"در حال بارگذاری..."}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-bordered table-sm align-middle text-center table-striped table-hover table-responsive",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"نام کاربری"}),e.jsx("th",{children:"نام"}),e.jsx("th",{children:"نام خانوادگی"}),e.jsx("th",{children:"کد ملی"}),e.jsx("th",{children:"ایمیل"}),e.jsx("th",{children:"موبایل"}),e.jsx("th",{children:"مرکز"}),e.jsx("th",{children:"وضعیت"}),e.jsx("th",{children:"عملیات"})]})}),e.jsxs("tbody",{children:[d.map((s,g)=>e.jsxs("tr",{children:[e.jsx("td",{children:g+1}),e.jsx("td",{children:s.username}),e.jsx("td",{children:s.firstName}),e.jsx("td",{children:s.lastName}),e.jsx("td",{children:s.nationalCode}),e.jsx("td",{children:s.email}),e.jsx("td",{children:s.mobile}),e.jsx("td",{children:a.find(w=>w.centerCode===s.centerCode)?.title||s.centerCode}),e.jsx("td",{children:e.jsx("span",{className:`badge bg-${s.isActive?"success":"secondary"}`,children:s.isActive?"فعال":"غیرفعال"})}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1 justify-content-center",children:[e.jsx("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>v(s),children:"ویرایش"}),e.jsx("button",{className:"btn btn-outline-primary btn-sm",onClick:()=>y(s),children:"نقش‌ها"}),e.jsx("button",{className:"btn btn-outline-danger btn-sm",onClick:()=>k(s.id),children:"ریست رمز"})]})})]},s.id)),d.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"7",children:"هیچ کاربری یافت نشد."})})]})]})}),h&&e.jsx(M,{mode:j,user:i,onClose:()=>x(!1),onSuccess:C}),o&&e.jsx(R,{user:i,onClose:()=>t(!1),onSuccess:C})]})}export{A as default};
